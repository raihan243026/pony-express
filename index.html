<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Action Pony Express ‚Äî Enhanced</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        :root{
            --desert-sand: #fef3c7;
            --sky-blue: #7dd3fc;
            --pony-brown: #8b4513;
            --cactus-green: #10b981;
            --rock-grey: #6b7280;
            --accent-red: #ef4444;
            --cloud-white: #f0f0f0;
            --text-color: #111827;
            --glass: rgba(255,255,255,0.08);
        }
        html,body{height:100%;}
        body{
            display:flex;align-items:center;justify-content:center;
            font-family:'Press Start 2P',cursive;background:#0f172a;padding:16px;color:var(--text-color);
        }
        .game-container{
            width:100%;max-width:920px;aspect-ratio:16/10;position:relative;border-radius:12px;overflow:hidden;
            box-shadow:0 20px 40px rgba(2,6,23,0.8);
            background:linear-gradient(180deg,#7dd3fc 30%, #fef3c7 30%);
        }
        canvas{display:block;width:100%;height:100%;background:transparent;touch-action:none}
        .overlay{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:30;padding:20px;backdrop-filter:blur(4px)}
        .panel{background:var(--glass);border:2px solid rgba(255,255,255,0.06);padding:18px;border-radius:10px;color:white;text-align:center}
        .title{font-size:clamp(18px,3vw,36px);color:var(--desert-sand);text-shadow:4px 4px 0 var(--accent-red);margin-bottom:10px}
        .btn{display:inline-block;padding:10px 18px;border-radius:8px;border:3px solid white;background:var(--accent-red);cursor:pointer;margin-top:12px}
        .controls{position:absolute;right:12px;top:12px;z-index:40;display:flex;gap:8px}
        .mini{background:rgba(255,255,255,0.06);padding:8px;border-radius:8px;color:white;border:2px solid rgba(255,255,255,0.04)}
        .hud{position:absolute;left:12px;top:12px;z-index:40;color:white;text-shadow:1px 1px rgba(0,0,0,0.6);font-size:12px}
        .mobile-hint{position:absolute;left:50%;transform:translateX(-50%);bottom:16px;color:white;font-size:11px;z-index:40}
        /* touch buttons for mobile */
        .touch-left,.touch-right{position:absolute;bottom:0;top:0;width:50%;z-index:20}
        .touch-left{left:0}
        .touch-right{right:0}
        @media (min-width:640px){.mobile-hint{display:none}}
        @media (max-width:639px){.controls{display:none}}
    </style>
</head>
<body>
    <div class="game-container" id="gameContainer">
        <canvas id="gameCanvas"></canvas>

        <div class="controls" role="toolbar">
            <div id="muteBtn" class="mini">üîä</div>
            <div id="pauseBtn" class="mini">‚è∏</div>
            <div id="resetBtn" class="mini">‚§ª</div>
        </div>

        <div class="hud" id="hud">SCORE: 0 &nbsp;|&nbsp; HI: 0 &nbsp;|&nbsp; LVL: 1</div>
        <div class="mobile-hint">Tap right to jump ‚Ä¢ Tap left to duck</div>

        <div id="overlay" class="overlay">
            <div class="panel">
                <div class="title">‚úâÔ∏è PONY EXPRESS</div>
                <div id="overlayText">Deliver mail across the desert. Jump, duck, collect mail and power-ups. Avoid obstacles!</div>
                <div style="margin-top:12px;font-size:11px;color:#f8fafc">High Score saved in browser</div>
                <div style="margin-top:12px">
                    <button id="startBtn" class="btn">START DELIVERY</button>
                </div>
                <div style="margin-top:10px;font-size:11px;color:#f3f4f6;">Controls: SPACE / UP = jump ‚Ä¢ DOWN = duck ‚Ä¢ Click/Tap</div>
            </div>
        </div>

        <!-- invisible touch zones for mobile -->
        <div class="touch-left" id="touchLeft"></div>
        <div class="touch-right" id="touchRight"></div>
    </div>

<script>
(() => {
    // Canvas and layout
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const container = document.getElementById('gameContainer');
    const overlay = document.getElementById('overlay');
    const startBtn = document.getElementById('startBtn');
    const muteBtn = document.getElementById('muteBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const resetBtn = document.getElementById('resetBtn');
    const hud = document.getElementById('hud');

    // Settings & state
    const GRAVITY = 1.0;
    const JUMP_VELOCITY = -18;
    const DUCK_HEIGHT = 30;
    const BASE_SPEED = 6;
    const MAX_SPEED = 15;
    const SPEED_INC = 0.004;

    let width, height, groundY;
    let frame = 0;
    let animationId;
    let gameState = 'menu'; // menu | playing | paused | over

    // gameplay state
    let score = 0;
    let hiScore = parseInt(localStorage.getItem('ponyHi') || '0', 10);
    let level = 1;
    let speed = BASE_SPEED;
    let obstacles = [];
    let mails = [];
    let powerups = [];
    let particles = [];

    // player
    const player = {
        x: 90,
        width: 56,
        height: 56,
        y: 0,
        vy: 0,
        isJumping: false,
        isDucking: false,
        trail: []
    };

    // Parallax layers
    const clouds = [];
    const dunes = [];

    // audio (simple tones)
    let audioCtx, masterGain; let muted=false;
    function initAudio(){
        if (audioCtx) return;
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        masterGain = audioCtx.createGain(); masterGain.connect(audioCtx.destination); masterGain.gain.value = 0.18;
    }
    function playTone(freq, time=0.08, type='sine'){
        if(muted) return; initAudio();
        const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
        o.type = type; o.frequency.value = freq; o.connect(g); g.connect(masterGain);
        g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.6, audioCtx.currentTime + 0.02);
        o.start(); o.stop(audioCtx.currentTime + time);
    }

    // utilities
    function rand(min,max){return Math.random()*(max-min)+min}
    function clamp(v,a,b){return Math.max(a,Math.min(b,v))}

    function resize(){
        width = container.clientWidth; height = container.clientHeight;
        canvas.width = width * devicePixelRatio; canvas.height = height * devicePixelRatio; canvas.style.width = width+'px'; canvas.style.height = height+'px';
        ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
        groundY = height * 0.62; player.y = groundY - player.height;
    }

    window.addEventListener('resize', resize);

    // spawn backgrounds
    function initBackground(){
        clouds.length=0; dunes.length=0;
        for(let i=0;i<6;i++) clouds.push({x: rand(0,width), y: rand(30, height*0.35), w: rand(80,200), speed: rand(0.3,1.2)});
        for(let i=0;i<10;i++) dunes.push({x: i*(width/8), y: groundY, w: width/8 + rand(-20,40), h: rand(20,60)});
    }

    // drawing
    function drawBackground(){
        // sky gradient
        const g = ctx.createLinearGradient(0,0,0,groundY);
        g.addColorStop(0,'#8ee3ff'); g.addColorStop(1,'#fef3c7');
        ctx.fillStyle = g; ctx.fillRect(0,0,width,groundY);

        // clouds
        clouds.forEach(c => {
            ctx.fillStyle = 'rgba(255,255,255,0.95)'; ctx.beginPath();
            ctx.ellipse(c.x, c.y, c.w*0.5, 20, 0,0,Math.PI*2); ctx.fill();
            c.x -= c.speed; if(c.x + c.w < 0) c.x = width + c.w; 
        });

        // dunes
        ctx.fillStyle = '#f6d365'; ctx.beginPath();
        ctx.moveTo(0, groundY+20);
        for(let i=0;i<dunes.length;i++){
            const d = dunes[i]; ctx.quadraticCurveTo(d.x + d.w*0.5, groundY - d.h, d.x + d.w, groundY+20);
            d.x -= speed*0.4; if(d.x + d.w < -50) d.x = width + rand(20,100);
        }
        ctx.lineTo(width, height); ctx.lineTo(0,height); ctx.closePath(); ctx.fill();

        // ground line
        ctx.strokeStyle = '#d97706'; ctx.lineWidth = 3; ctx.beginPath(); ctx.moveTo(0,groundY); ctx.lineTo(width,groundY); ctx.stroke();
    }

    function drawPlayer(){
        // trail
        player.trail.push({x:player.x+player.width/2,y:player.y+player.height/2,r: rand(4,8), life:18});
        if(player.trail.length>12) player.trail.shift();
        player.trail.forEach(t=>{ctx.fillStyle = `rgba(250,204,21,${t.life/20})`; ctx.beginPath(); ctx.arc(t.x,t.y,t.r,0,Math.PI*2); ctx.fill(); t.life--;});

        // body
        ctx.fillStyle = 'var(--pony-brown)';
        const h = player.isDucking?DUCK_HEIGHT:player.height;
        ctx.fillRect(player.x, player.y + (player.height - h), player.width, h);
        // legs
        ctx.fillStyle = '#3c2f2f'; ctx.fillRect(player.x+8, player.y+22 + (player.isDucking?10:0), 10, 10);
        ctx.fillRect(player.x+32, player.y+22 + (player.isDucking?10:0), 10, 10);
        // rider hat
        ctx.fillStyle = 'var(--accent-red)'; ctx.fillRect(player.x+player.width-18, player.y - 8, 14, 14);
    }

    function drawObstacles(){
        obstacles.forEach(o=>{
            ctx.fillStyle = o.color; ctx.fillRect(o.x, o.y, o.w, o.h);
            if(o.type==='cactus'){
                ctx.fillStyle = '#065f46'; ctx.fillRect(o.x+5,o.y,6,o.h/2); ctx.fillRect(o.x+o.w-12,o.y+10,6,o.h/2);
            } else if(o.type==='bird'){
                ctx.fillStyle = '#4b5e2a'; ctx.beginPath(); ctx.moveTo(o.x,o.y+o.h/2); ctx.lineTo(o.x+o.w,o.y); ctx.lineTo(o.x+o.w,o.y+o.h); ctx.closePath(); ctx.fill();
            }
        });
    }

    function drawMails(){
        mails.forEach(m=>{ ctx.fillStyle='#facc15'; ctx.fillRect(m.x,m.y,m.w,m.h); ctx.fillStyle='#dc2626'; ctx.fillRect(m.x,m.y, m.w, 4); });
    }

    function drawPowerups(){
        powerups.forEach(p=>{ ctx.fillStyle=p.color; ctx.beginPath(); ctx.arc(p.x,p.y, p.r,0,Math.PI*2); ctx.fill(); ctx.fillStyle='white'; ctx.font='10px "Press Start 2P"'; ctx.fillText(p.label, p.x-6, p.y+3); });
    }

    function drawParticles(){
        particles = particles.filter(p=>p.life>0);
        particles.forEach(p=>{ ctx.fillStyle = `rgba(255,${180+p.life*2},0,${p.life/20})`; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill(); p.x+=p.vx; p.y+=p.vy; p.life--; });
    }

    function drawHUD(){ hud.innerHTML = `SCORE: ${score} &nbsp;|&nbsp; HI: ${hiScore} &nbsp;|&nbsp; LVL: ${level}`; }

    // game updates
    function spawnObstacle(){
        const t = Math.random(); let o;
        if(t<0.5){ // cactus
            const h = rand(36,70); o = {x:width+20, y:groundY-h, w:20+rand(0,14), h:h, type:'cactus', color:'#10b981'};
        } else if(t<0.85){ // rock
            const h = rand(20,36); o = {x:width+20,y:groundY-h,w:28+rand(0,14),h:h,type:'rock',color:'#6b7280'};
        } else { // bird
            o = {x:width+20,y:groundY-80-rand(0,40),w:30,h:20,type:'bird',color:'#8b5cf6', bob: rand(0.4,1.2)};
        }
        obstacles.push(o);
    }

    function spawnMail(){ if(Math.random()<0.6){ const m={x:width+10,y:groundY-40-rand(0,80),w:26,h:18, val:30}; mails.push(m);} }

    function spawnPowerup(){ if(Math.random()<0.08){ const pType = Math.random()<0.5?'shield':'magnet'; powerups.push({x:width+20,y:groundY-80-rand(0,80),r:12,label:pType==='shield'?'S':'M',type:pType,color:pType==='shield'?'#60a5fa':'#f59e0b',life:600}); } }

    function createParticlesAt(x,y,count=12){ for(let i=0;i<count;i++){ particles.push({x:x,y:y,vx:rand(-3,3),vy:rand(-3,2),r:rand(2,5),life:20+Math.floor(rand(0,10))}); } }

    function rectCollide(a,b){ return a.x < b.x + b.w && a.x + a.width > b.x && a.y < b.y + b.h && a.y + a.height > b.y; }

    let magnetActive=false, shieldActive=false, magnetTimer=0, shieldTimer=0;

    function update(dt){
        frame++;
        // speed grow by score
        speed = clamp(BASE_SPEED + (score/500) + (level-1)*0.4, BASE_SPEED, MAX_SPEED);
        // player physics
        if(player.isJumping){ player.vy += GRAVITY; player.y += player.vy; if(player.y + player.height >= groundY){ player.y = groundY - player.height; player.vy = 0; player.isJumping=false; }}
        if(player.isDucking){ /* ducking simply shrinks drawing */ }

        // obstacles
        obstacles.forEach(o=>{ o.x -= speed; if(o.type==='bird') o.y += Math.sin(frame/12)*o.bob; }); obstacles = obstacles.filter(o=>o.x+o.w> -50);
        // mails
        mails.forEach(m=>{ if(magnetActive){ const dx = (player.x+player.width/2)-m.x; m.x += dx*0.12; } else m.x -= speed; }); mails = mails.filter(m=>m.x+m.w> -40);
        // powerups
        powerups.forEach(p=>{ p.x -= speed; p.life--; }); powerups = powerups.filter(p=>p.x + p.r > -40 && p.life>0);

        // spawn logic
        if(frame % Math.floor(140 - speed*8) === 0) spawnObstacle();
        if(frame % 240 === 0) spawnMail();
        if(frame % 900 === 0) spawnPowerup();

        // collisions with mail
        for(let i=mails.length-1;i>=0;i--){ const m=mails[i]; if(playerRect().x < m.x + m.w && playerRect().x + playerRect().width > m.x && playerRect().y < m.y + m.h && playerRect().y + playerRect().height > m.y){ score += m.val * (magnetActive?2:1); createParticlesAt(m.x,m.y); playTone(880,0.08,'sine'); mails.splice(i,1); } }

        // collisions with powerups
        for(let i=powerups.length-1;i>=0;i--){ const p=powerups[i]; if(playerRect().x < p.x + p.r && playerRect().x + playerRect().width > p.x - p.r && playerRect().y < p.y + p.r && playerRect().y + playerRect().height > p.y - p.r){ if(p.type==='magnet'){ magnetActive=true; magnetTimer=900; } else { shieldActive=true; shieldTimer=600; } powerups.splice(i,1); playTone(1200,0.12,'triangle'); } }

        if(magnetActive){ magnetTimer--; if(magnetTimer<=0) magnetActive=false; }
        if(shieldActive){ shieldTimer--; if(shieldTimer<=0) shieldActive=false; }

        // obstacle collision
        for(let i=0;i<obstacles.length;i++){
            const o = obstacles[i]; const pr = playerRect(); if(pr.x < o.x + o.w && pr.x + pr.width > o.x && pr.y < o.y + o.h && pr.y + pr.height > o.y){ if(shieldActive){ createParticlesAt(o.x+o.w/2,o.y+o.h/2,20); obstacles.splice(i,1); shieldActive=false; playTone(440,0.08,'square'); score+=20; } else { gameOver(); return; } }}

        // level up every 1200 frames
        if(frame % 1200 === 0){ level++; playTone(500,0.12,'sawtooth'); }

        // score over time
        if(frame % 6 === 0) score += 1;
        draw();
    }

    function playerRect(){ return {x:player.x, y: player.y + (player.isDucking ? player.height - DUCK_HEIGHT : 0), width: player.width, height: player.isDucking?DUCK_HEIGHT:player.height}; }

    function gameOver(){ gameState='over'; cancelAnimationFrame(animationId); overlay.style.display='flex'; document.querySelector('#overlayText').innerHTML = `Delivery Failed! Score: ${score} ‚Äî Press START to try again.`; if(score>hiScore){ hiScore=score; localStorage.setItem('ponyHi', ''+hiScore); } playTone(180,0.3,'square'); }

    function resetGame(){ score=0; level=1; speed=BASE_SPEED; obstacles=[]; mails=[]; powerups=[]; particles=[]; frame=0; magnetActive=false; shieldActive=false; }

    function startGame(){ resetGame(); overlay.style.display='none'; gameState='playing'; initAudio(); initBackground(); loop(); }

    function loop(){ const now = performance.now(); update(16); if(gameState==='playing') animationId = requestAnimationFrame(loop); }

    function draw(){ ctx.clearRect(0,0,width,height); drawBackground(); drawObstacles(); drawMails(); drawPowerups(); drawParticles(); drawPlayer(); drawHUD();
        // draw powerup HUD
        if(magnetActive){ ctx.fillStyle='#f59e0b'; ctx.fillText('MAGNET', width-120, 30); }
        if(shieldActive){ ctx.fillStyle='#60a5fa'; ctx.fillText('SHIELD', width-120, 48); }
    }

    // controls
    function jump(){ if(gameState!=='playing') return; if(!player.isJumping){ player.vy = JUMP_VELOCITY; player.isJumping=true; playTone(440,0.06,'triangle'); }}
    function duck(on){ if(gameState!=='playing') return; player.isDucking = !!on; }

    document.addEventListener('keydown', e=>{
        if(e.code==='Space' || e.code==='ArrowUp'){ e.preventDefault(); if(gameState==='menu' || gameState==='over'){ startGame(); } else jump(); }
        if(e.code==='ArrowDown'){ duck(true); }
        if(e.code==='KeyP'){ if(gameState==='playing'){ gameState='paused'; cancelAnimationFrame(animationId); overlay.style.display='flex'; document.querySelector('#overlayText').innerHTML='PAUSED'; } else if(gameState==='paused'){ overlay.style.display='none'; gameState='playing'; loop(); } }
    });
    document.addEventListener('keyup', e=>{ if(e.code==='ArrowDown') duck(false); });

    // mouse & touch
    canvas.addEventListener('click', ()=>{ if(gameState==='menu' || gameState==='over'){ startGame(); } else jump(); });
    document.getElementById('touchRight').addEventListener('touchstart', (e)=>{ e.preventDefault(); if(gameState==='menu' || gameState==='over') startGame(); else jump(); });
    document.getElementById('touchLeft').addEventListener('touchstart', (e)=>{ e.preventDefault(); duck(true); });
    document.getElementById('touchLeft').addEventListener('touchend', (e)=>{ e.preventDefault(); duck(false); });

    // UI buttons
    startBtn.addEventListener('click', ()=> startGame());
    muteBtn.addEventListener('click', ()=>{ muted = !muted; muteBtn.textContent = muted? 'üîá':'üîä'; });
    pauseBtn.addEventListener('click', ()=>{ if(gameState==='playing'){ gameState='paused'; cancelAnimationFrame(animationId); overlay.style.display='flex'; document.querySelector('#overlayText').innerHTML='PAUSED'; } else if(gameState==='paused'){ overlay.style.display='none'; gameState='playing'; loop(); } });
    resetBtn.addEventListener('click', ()=>{ resetGame(); overlay.style.display='flex'; document.querySelector('#overlayText').innerHTML='Reset ‚Äî Press START'; gameState='menu'; });

    // init
    resize(); initBackground(); ctx.font='12px "Press Start 2P"'; ctx.fillStyle='white';
    document.querySelector('#overlayText').innerHTML = `Deliver mail ‚Äî jump, duck, and collect! High score: ${hiScore}`;
})();
</script>
</body>
</html>
